<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma del Consentimiento - Caminos del Ser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F8F7F2; color: #4A4A4A; }
        h1, h2 { font-family: 'Poppins', sans-serif; color: #1a1a1a; font-weight: 700; }
        .btn-brand { background-color: #003366; color: white; padding: 12px 30px; border-radius: 9999px; font-weight: 600; transition: all 0.3s ease; }
        .btn-brand:hover { background-color: #002244; }
        .btn-brand:disabled { background-color: #99aabb; cursor: not-allowed; }
        .card { background-color: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        #firmaCanvas { border: 2px dashed #d1d5db; border-radius: 8px; cursor: crosshair; touch-action: none; }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-2 flex justify-between items-center">
            <a href="index.html">
                <img src="logoprincipal.png" alt="Caminos del Ser Logo" class="h-11 w-auto">
            </a>
            <a href="index.html" class="text-sm font-medium text-gray-600 hover:text-[#003366]">Volver al Consentimiento</a>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="max-w-2xl mx-auto card text-center">
            <h1 class="text-3xl font-bold mb-2">Paso Final: Tu Firma</h1>
            <p class="text-gray-600 mb-6">Por favor, firma en el siguiente recuadro para validar tu consentimiento.</p>

            <div class="w-full max-w-md mx-auto">
                <canvas id="firmaCanvas"></canvas>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button id="limpiarFirmaBtn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-full font-semibold hover:bg-gray-300 transition">Limpiar</button>
                <button id="enviarBtn" class="btn-brand">Enviar Consentimiento</button>
            </div>
            <div id="server-message" class="mt-6 text-center font-semibold hidden"></div>
        </div>
    </main>

    <footer class="bg-[#1a1a1a] text-white py-8 mt-16">
        <div class="container mx-auto text-center">
            <p class="text-gray-400">&copy; 2025 Jorge Arango Castaño - Caminos del Ser. Todos los derechos reservados.</p>
            <div class="mt-4">
                <a href="https://www.caminosdelser.co/politicadatos.html" target="_blank" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">Política de tratamiento de datos</a>
                <span class="text-gray-600 mx-2">|</span>
                <a href="login.html" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">Acceso Terapeuta</a>
            </div>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('firmaCanvas');
        const ctx = canvas.getContext('2d');
        const limpiarBtn = document.getElementById('limpiarFirmaBtn');
        const enviarBtn = document.getElementById('enviarBtn');
        const serverMessageDiv = document.getElementById('server-message');

        let dibujando = false;
        let firmaVacia = true;

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = 2;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / (rect.width * window.devicePixelRatio);
            const scaleY = canvas.height / (rect.height * window.devicePixelRatio);

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function iniciarDibujo(e) {
            e.preventDefault();
            dibujando = true;
            firmaVacia = false;
            const coords = getCoords(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function dibujar(e) {
            if (!dibujando) return;
            e.preventDefault();
            const coords = getCoords(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function detenerDibujo() {
            dibujando = false;
            ctx.closePath();
        }

        canvas.addEventListener('mousedown', iniciarDibujo);
        canvas.addEventListener('mousemove', dibujar);
        canvas.addEventListener('mouseup', detenerDibujo);
        canvas.addEventListener('mouseout', detenerDibujo);

        canvas.addEventListener('touchstart', iniciarDibujo, { passive: false });
        canvas.addEventListener('touchmove', dibujar, { passive: false });
        canvas.addEventListener('touchend', detenerDibujo, { passive: false });

        limpiarBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            firmaVacia = true;
        });

        enviarBtn.addEventListener('click', async () => {
            serverMessageDiv.classList.add('hidden');
            
            if (firmaVacia) {
                serverMessageDiv.textContent = 'Por favor, proporciona tu firma.';
                serverMessageDiv.className = 'mt-6 text-center font-semibold text-red-600';
                serverMessageDiv.classList.remove('hidden');
                return;
            }

            const datosTemporales = sessionStorage.getItem('datosConsentimiento');
            if (!datosTemporales) {
                serverMessageDiv.textContent = 'Error: No se encontraron los datos demográficos. Por favor, vuelve a empezar.';
                serverMessageDiv.className = 'mt-6 text-center font-semibold text-red-600';
                serverMessageDiv.classList.remove('hidden');
                return;
            }

            enviarBtn.disabled = true;
            enviarBtn.textContent = 'Procesando...';

            try {
                const datosCompletos = JSON.parse(datosTemporales);
                datosCompletos.firmaDigital = canvas.toDataURL('image/png');

                const response = await fetch('/api/save-consent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosCompletos)
                });

                if (response.ok) {
                    serverMessageDiv.textContent = '¡Gracias! Tu consentimiento ha sido enviado exitosamente.';
                    serverMessageDiv.className = 'mt-6 text-center font-semibold text-green-600';
                    sessionStorage.removeItem('datosConsentimiento');
                    limpiarBtn.disabled = true;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Hubo un problema en el servidor.');
                }
            } catch (error) {
                serverMessageDiv.textContent = `Hubo un error al enviar tu consentimiento. Detalle: ${error.message}`;
                serverMessageDiv.className = 'mt-6 text-center font-semibold text-red-600';
                enviarBtn.disabled = false;
                enviarBtn.textContent = 'Enviar Consentimiento';
            } finally {
                 serverMessageDiv.classList.remove('hidden');
            }
        });
    });
    </script>
</body>
</html>
